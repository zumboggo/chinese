<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Parallel Text Reader â€” Library PWA</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<style>
  :root {
    --bg: #f7f7fb;
    --card: #ffffff;
    --primary: #2563eb;
    --text: #111827;
    --muted: #6b7280;
    --shadow: 0 6px 18px rgba(0,0,0,0.08);
    --radius: 14px;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0; padding: 0.75rem;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg); color: var(--text);
  }
  header {
    background: linear-gradient(135deg, var(--primary), #4f46e5);
    color: #fff; text-align: center;
    padding: 0.8rem 1rem; border-radius: var(--radius);
    box-shadow: var(--shadow);
    font-weight: 700; letter-spacing: 0.2px;
  }
  .wrap { max-width: 900px; margin: 0.8rem auto; display: grid; gap: 0.9rem; }
  .card {
    background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
    padding: 0.9rem;
  }
  .row { display: grid; gap: 0.6rem; }
  @media (min-width: 640px){ .row-cols-2 { grid-template-columns: 1fr 1fr; gap: 0.6rem; } }
  label { font-size: 0.9rem; color: var(--muted); }
  select, input[type="file"], button {
    width: 100%; font-size: 1rem; padding: 0.7rem 0.8rem;
    border: 1px solid #e5e7eb; border-radius: 12px; background: #fff;
  }
  button.primary { background: var(--primary); color:#fff; border:none; font-weight:600; }
  button.ghost { background: #fff; border: 1px solid #e5e7eb; }
  button:active { transform: translateY(1px); }
  .pill { display:inline-flex; align-items:center; gap:.5rem; padding:.45rem .65rem; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:.85rem; }
  .reader { display: grid; gap: 0.75rem; }
  .pane {
    background:#fff; border-radius:12px; padding:1rem;
    overflow-y:auto; box-shadow: inset 0 0 0 1px #f1f5f9;
    white-space: pre-wrap; line-height:1.6;
  }
  #englishDisplay { height: 45vh; font-size: 1.15rem; }
  #chineseDisplay { height: 30vh; font-size: 1.05rem; }
  .toolbar { display:grid; gap:.5rem; align-items:center; }
  @media (min-width:640px){ .toolbar { grid-template-columns: 1fr auto auto; } }
</style>
</head>
<body>
  <header>ðŸ“– Parallel Text Reader â€” Library</header>
  <div class="wrap">

    <section class="card row">
      <div class="row row-cols-2">
        <div>
          <label for="csvInput">Add CSV (Col1=Chinese, Col2=English, Col3=Title)</label>
          <input id="csvInput" type="file" accept=".csv" />
          <div style="font-size:.85rem;color:var(--muted);margin-top:.3rem;">Files are stored locally (IndexedDB) for offline use.</div>
        </div>
        <div>
          <label for="fileSelector">CSV Files (Library)</label>
          <select id="fileSelector" disabled>
            <option value="">â€” No CSV in library â€”</option>
          </select>
        </div>
      </div>
      <div>
        <label for="storySelector">Stories in Selected CSV (by Title)</label>
        <select id="storySelector" disabled>
          <option value="">â€” Select a CSV first â€”</option>
        </select>
      </div>
      <div class="row row-cols-2">
        <button id="deleteCsv" class="ghost">Delete Selected CSV</button>
        <button id="clearAll" class="ghost">Clear Entire Library</button>
      </div>
      <div><span class="pill" id="statusPill">0 files â€¢ 0 stories</span></div>
    </section>

    <section class="card row">
      <div class="toolbar">
        <div class="pill" id="nowReading">Now reading: â€”</div>
        <button id="shareBtn" class="ghost">Export Current Story (.txt)</button>
        <button id="installBtn" class="primary" hidden>Install App</button>
      </div>
      <div class="reader">
        <div class="pane" id="englishDisplay" aria-label="English text"></div>
        <div class="pane" id="chineseDisplay" aria-label="Chinese text"></div>
      </div>
    </section>

  </div>

<script>
/* ========== IndexedDB Helpers ========== */
const DB_NAME = 'parallel-reader-db';
const STORE = 'csvLibrary';

function dbOpen(){
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(STORE)) {
        db.createObjectStore(STORE, { keyPath: 'id' }); // {id, fileName, addedAt, stories:[{title,english,chinese}]}
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

function dbPut(entry){
  return dbOpen().then(db => new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, 'readwrite');
    tx.objectStore(STORE).put(entry);
    tx.oncomplete = () => resolve();
    tx.onerror = () => reject(tx.error);
  }));
}

function dbDelete(id){
  return dbOpen().then(db => new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, 'readwrite');
    tx.objectStore(STORE).delete(id);
    tx.oncomplete = () => resolve();
    tx.onerror = () => reject(tx.error);
  }));
}

function dbGetAll(){
  return dbOpen().then(db => new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, 'readonly');
    const req = tx.objectStore(STORE).getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => reject(req.error);
  }));
}

/* ========== State & Elements ========== */
const datasets = new Map(); // id -> {id,fileName,stories}
const fileSelector = document.getElementById('fileSelector');
const storySelector = document.getElementById('storySelector');
const statusPill = document.getElementById('statusPill');
const nowReading = document.getElementById('nowReading');
const englishDisplay = document.getElementById('englishDisplay');
const chineseDisplay = document.getElementById('chineseDisplay');

const csvInput = document.getElementById('csvInput');
const deleteCsvBtn = document.getElementById('deleteCsv');
const clearAllBtn = document.getElementById('clearAll');
const shareBtn = document.getElementById('shareBtn');

/* ========== CSV Parsing (robust) ========== */
function parseCSV(text) {
  const rows = [];
  let i = 0, field = '', row = [], inQuotes = false;
  text = text.replace(/\r\n/g, '\\n').replace(/\\r/g, '\\n');
  while (i < text.length) {
    const c = text[i];
    if (inQuotes) {
      if (c === '"') {
        if (text[i+1] === '"') { field += '"'; i+=2; continue; }
        inQuotes = false; i++; continue;
      } else { field += c; i++; continue; }
    } else {
      if (c === '"') { inQuotes = true; i++; continue; }
      if (c === ',') { row.push(field); field=''; i++; continue; }
      if (c === '\\n') { row.push(field); field=''; rows.push(row); row=[]; i++; continue; }
      field += c; i++; continue;
    }
  }
  row.push(field); rows.push(row);
  return rows;
}

/* ========== Library Management ========== */
async function loadLibrary(){
  const all = await dbGetAll();
  datasets.clear();
  for (const entry of all) {
    datasets.set(entry.id, entry);
  }
  updateFileSelector();
  updateStatus();
}

csvInput.addEventListener('change', async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  const text = await file.text();
  const rows = parseCSV(text);

  const stories = [];
  for (let idx=0; idx<rows.length; idx++){
    const r = rows[idx];
    if (!r || r.length < 3) continue;
    if (idx===0 && r[0] && r[0].charCodeAt(0) === 0xFEFF) r[0] = r[0].slice(1);
    const chinese = (r[0] ?? '').trim();
    const english = (r[1] ?? '').trim();
    const title   = ((r[2] ?? '').trim()) || `Story ${idx+1}`;
    if (!chinese && !english && !title) continue;
    stories.push({ title, english, chinese });
  }

  const id = file.name; // use file name as id; overwrites on re-import
  const entry = { id, fileName: file.name, addedAt: Date.now(), stories };
  await dbPut(entry);
  await loadLibrary();
  fileSelector.value = id;
  populateStorySelector();
  csvInput.value='';
});

function updateFileSelector(){
  const prev = fileSelector.value;
  fileSelector.innerHTML = '';
  if (datasets.size === 0) {
    fileSelector.disabled = true;
    fileSelector.innerHTML = '<option value="">â€” No CSV in library â€”</option>';
    storySelector.disabled = true;
    storySelector.innerHTML = '<option value="">â€” Select a CSV first â€”</option>';
    return;
  }
  fileSelector.disabled = false;
  Array.from(datasets.values())
    .sort((a,b)=> (a.fileName||'').localeCompare(b.fileName||''))
    .forEach(ds => {
      const opt = document.createElement('option');
      opt.value = ds.id;
      opt.textContent = ds.fileName;
      fileSelector.appendChild(opt);
    });
  if (datasets.has(prev)) fileSelector.value = prev;
}

fileSelector.addEventListener('change', () => {
  populateStorySelector();
  updateStatus();
});

function populateStorySelector(){
  const id = fileSelector.value;
  const ds = datasets.get(id);
  storySelector.innerHTML = '';
  if (!ds || !ds.stories?.length) {
    storySelector.disabled = true;
    storySelector.innerHTML = '<option value="">â€” No stories in this CSV â€”</option>';
    return;
  }
  storySelector.disabled = false;
  ds.stories.forEach((s, i) => {
    const opt = document.createElement('option');
    opt.value = i.toString();
    opt.textContent = s.title || `Story ${i+1}`;
    storySelector.appendChild(opt);
  });
}

storySelector.addEventListener('change', () => {
  const id = fileSelector.value;
  const ds = datasets.get(id);
  const idx = parseInt(storySelector.value, 10);
  if (!ds || Number.isNaN(idx)) return;
  const story = ds.stories[idx];
  displayStory(story, `${ds.fileName} â€¢ ${story.title}`);
  updateStatus();
});

clearAllBtn.addEventListener('click', async () => {
  // delete all by reopening DB and clearing store
  const db = await dbOpen();
  await new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, 'readwrite');
    const req = tx.objectStore(STORE).clear();
    tx.oncomplete = () => resolve();
    tx.onerror = () => reject(tx.error);
  });
  await loadLibrary();
  englishDisplay.textContent = '';
  chineseDisplay.textContent = '';
  nowReading.textContent = 'Now reading: â€”';
});

deleteCsvBtn.addEventListener('click', async () => {
  const id = fileSelector.value;
  if (!id) return;
  await dbDelete(id);
  await loadLibrary();
  englishDisplay.textContent = '';
  chineseDisplay.textContent = '';
  nowReading.textContent = 'Now reading: â€”';
});

/* ========== Display & Export ========== */
function displayStory(story, label){
  englishDisplay.textContent = story.english || '';
  chineseDisplay.textContent = story.chinese || '';
  nowReading.textContent = `Now reading: ${label || (story.title ?? 'â€”')}`;
  englishDisplay.scrollTop = 0; chineseDisplay.scrollTop = 0;
}

shareBtn.addEventListener('click', () => {
  const en = englishDisplay.textContent || '';
  const zh = chineseDisplay.textContent || '';
  if (!en && !zh) return;
  const blob = new Blob([en + "\\n\\n---\\n\\n" + zh], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'story.txt'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 5000);
});

/* ========== Install Prompt (Add to Home Screen) ========== */
let deferredPrompt = null;
const installBtn = document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.hidden = false;
});
installBtn.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  deferredPrompt = null;
  installBtn.hidden = true;
});

/* ========== Service Worker ========== */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js').catch(console.error);
}

/* ========== Init ========== */
loadLibrary().catch(console.error);
</script>
</body>
</html>
