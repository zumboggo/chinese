<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Parallel Text Reader (Synced Highlight)</title>
<style>
  :root {
    --bg: linear-gradient(to bottom, #87CEEB, #E0F7FF);
    --card: #ffffff;
    --primary: #1d4ed8;
    --text: #111827;
    --muted: #6b7280;
    --shadow: 0 6px 18px rgba(0,0,0,0.08);
    --radius: 14px;
    --read: #0f766e;   /* teal-ish for "read" */
    --unread: #94a3b8; /* slate-ish for "unread" */
  }
  * { box-sizing: border-box; }
  body {
    margin: 0; padding: 0.75rem;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg); color: var(--text);
  }
  header {
    background: linear-gradient(135deg, var(--primary), #3b82f6);
    color: #fff; text-align: center;
    padding: 0.8rem 1rem; border-radius: var(--radius);
    box-shadow: var(--shadow);
    font-weight: 700; letter-spacing: 0.2px;
  }
  .wrap {
    max-width: 900px; margin: 0.8rem auto; display: grid; gap: 0.9rem;
  }
  .card {
    background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
    padding: 0.9rem;
  }
  .row { display: grid; gap: 0.6rem; }
  @media (min-width: 560px){
    .row-cols { grid-template-columns: 1fr 1fr; gap: 0.6rem; }
  }
  label { font-size: 0.9rem; color: var(--muted); }
  input[type="text"], select, button {
    width: 100%; font-size: 1rem; padding: 0.7rem 0.8rem;
    border: 1px solid #e5e7eb; border-radius: 12px; background: #fff;
  }
  input[type="file"]{ font-size: 0.95rem; }
  button.primary {
    background: var(--primary); color: #fff; border: none; font-weight: 600;
  }
  button.ghost { background: #fff; border: 1px solid #e5e7eb; color: #111827; }
  button:active { transform: translateY(1px); }
  .help { font-size: 0.85rem; color: var(--muted); }
  .stack { display: grid; gap: 0.5rem; }
  .reader { display: grid; gap: 0.75rem; }
  .pane {
    background: #fff; border-radius: 12px; padding: 0.9rem;
    overflow-y: auto; box-shadow: inset 0 0 0 1px #f1f5f9;
    line-height: 1.8; font-size: 1.75rem; /* larger by default */
  }
  #englishDisplay { max-height: 70vh; }
  .toolbar {
    display: grid; gap: 0.5rem;
  }
  @media (min-width: 560px){
    .toolbar { grid-template-columns: 1fr auto auto auto; align-items: end; }
  }
  .pill {
    display: inline-flex; align-items: center; gap: 0.5rem;
    padding: 0.5rem 0.65rem; border-radius: 999px; background: #f3f4f6; color: #374151;
    font-size: 0.85rem;
  }
  /* word highlighting */
  .w {
    transition: color 260ms linear, background-color 260ms linear;
    color: var(--unread);
    background-image: linear-gradient( to top, rgba(15,118,110,0.10), rgba(15,118,110,0.00) );
    background-size: 0% 100%;
    background-repeat: no-repeat;
    border-radius: 6px;
    padding: 0 2px;
  }
  .w.read {
    color: var(--read);
    background-size: 100% 100%;
  }
  .controls-grid {
    display: grid;
    gap: 0.6rem;
  }
  @media (min-width: 560px){
    .controls-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); align-items: end; }
  }
  .inline {
    display: inline-flex; gap: 0.5rem; align-items: center; font-size: 0.95rem;
  }
</style>
</head>
<body>
  <header>ðŸ“– Parallel Text Reader</header>
  <div class="wrap">

    <!-- CSV Loader & Two-Level Selection -->
    <section class="card row">
      <div class="row row-cols">
        <div class="stack">
          <label for="csvInput">Add CSV (Col1=Chinese, Col2=English, Col3=Title)</label>
          <input id="csvInput" type="file" accept=".csv" />
          <div class="help">You can add multiple CSVs. Each row becomes a story. Only the Title (col 3) shows in the story list.</div>
        </div>
        <div class="stack">
          <label>CSV Files</label>
          <select id="fileSelector" disabled>
            <option value="">â€” No CSV loaded â€”</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="stack">
          <label>Stories in Selected CSV (by Title)</label>
          <select id="storySelector" disabled>
            <option value="">â€” Select a CSV first â€”</option>
          </select>
        </div>
      </div>
      <div class="row row-cols">
        <button id="clearAll" class="ghost">Clear All CSVs</button>
        <span class="pill" id="statusPill">0 files â€¢ 0 stories</span>
      </div>
    </section>

    <!-- Reader panes & audio controls -->
    <section class="card row">
      <div class="toolbar">
        <div class="pill" id="nowReading">Now reading: â€”</div>
        <button id="playZH" class="ghost">Play Chinese</button>
        <button id="stopAll" class="ghost">Stop Audio</button>
        <button id="resetHL" class="ghost">Reset Highlight</button>
      </div>

      <div class="controls-grid">
        <label class="inline"><input type="checkbox" id="autoHighlight" checked/> Auto-highlight English</label>
        <label class="inline"><input type="checkbox" id="followScroll" checked/> Follow reading (auto-scroll)</label>
        <div class="stack">
          <label for="fallbackWPM">Fallback highlight speed (WPM)</label>
          <input type="range" id="fallbackWPM" min="60" max="280" step="5" value="180"/>
        </div>
        <div class="stack">
          <label for="scrollSpeed">Manual Scroll (when not following)</label>
          <input type="range" id="scrollSpeed" min="0" max="10" value="0" />
        </div>
      </div>

      <div class="reader">
        <div class="pane" id="englishDisplay" aria-label="English text"></div>
      </div>
    </section>

  </div>

<script>
/* ========= Data Structures ========= */
const datasets = new Map(); // key: fileName, value: {fileName, stories: [{title, english, chinese}]}
const fileSelector = document.getElementById('fileSelector');
const storySelector = document.getElementById('storySelector');
const statusPill = document.getElementById('statusPill');
const nowReading = document.getElementById('nowReading');

const englishDisplay = document.getElementById('englishDisplay');
let currentChinese = '';
let currentEnglish = '';
let englishWordSpans = []; // <span> nodes, each word
let totalWords = 0;

const csvInput = document.getElementById('csvInput');
const clearAllBtn = document.getElementById('clearAll');
const playZHBtn = document.getElementById('playZH');
const stopAllBtn = document.getElementById('stopAll');
const resetHLBtn = document.getElementById('resetHL');
const scrollSpeed = document.getElementById('scrollSpeed');
const autoHighlight = document.getElementById('autoHighlight');
const followScroll = document.getElementById('followScroll');
const fallbackWPM = document.getElementById('fallbackWPM');

let manualScrollInterval = null;

/* ========= CSV Parsing (handles quotes) ========= */
function parseCSV(text) {
  const rows = [];
  let i = 0, field = '', row = [], inQuotes = false;
  text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

  while (i < text.length) {
    const char = text[i];
    if (inQuotes) {
      if (char === '"') {
        if (text[i+1] === '"') { field += '"'; i += 2; continue; }
        inQuotes = false; i++; continue;
      } else { field += char; i++; continue; }
    } else {
      if (char === '"') { inQuotes = true; i++; continue; }
      else if (char === ',') { row.push(field); field=''; i++; continue; }
      else if (char === '\n') { row.push(field); field=''; rows.push(row); row=[]; i++; continue; }
      else { field += char; i++; continue; }
    }
  }
  row.push(field);
  rows.push(row);
  return rows;
}

/* ========= File Handling ========= */
csvInput.addEventListener('change', async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;

  const fileName = file.name;
  const text = await file.text();
  const rows = parseCSV(text);

  const stories = [];
  for (let idx=0; idx<rows.length; idx++){
    const r = rows[idx];
    if (!r || r.length < 3) continue;
    if (idx===0 && r[0] && r[0].charCodeAt(0) === 0xFEFF) r[0] = r[0].slice(1);
    const chinese = (r[0] ?? '').trim();
    const english = (r[1] ?? '').trim();
    const title = ((r[2] ?? '').trim()) || `Story ${idx+1}`;
    if (!chinese && !english && !title) continue;
    stories.push({ title, english, chinese });
  }

  datasets.set(fileName, { fileName, stories });
  updateFileSelector();
  fileSelector.value = fileName;
  populateStorySelector();
  updateStatus();
  csvInput.value = '';
});

function updateFileSelector(){
  const prevValue = fileSelector.value;
  fileSelector.innerHTML = '';
  if (datasets.size === 0) {
    fileSelector.disabled = true;
    fileSelector.innerHTML = '<option value="">â€” No CSV loaded â€”</option>';
    storySelector.disabled = true;
    storySelector.innerHTML = '<option value="">â€” Select a CSV first â€”</option>';
    return;
  }
  fileSelector.disabled = false;
  for (const key of datasets.keys()) {
    const opt = document.createElement('option');
    opt.value = key;
    opt.textContent = key;
    fileSelector.appendChild(opt);
  }
  if (datasets.has(prevValue)) fileSelector.value = prevValue;
}

fileSelector.addEventListener('change', () => {
  populateStorySelector();
  updateStatus();
});

function populateStorySelector(){
  const key = fileSelector.value;
  const ds = datasets.get(key);
  storySelector.innerHTML = '';
  if (!ds || !ds.stories?.length) {
    storySelector.disabled = true;
    storySelector.innerHTML = '<option value="">â€” No stories in this CSV â€”</option>';
    return;
  }
  storySelector.disabled = false;
  ds.stories.forEach((s, i) => {
    const opt = document.createElement('option');
    opt.value = i.toString();
    opt.textContent = s.title || `Story ${i+1}`;
    storySelector.appendChild(opt);
  });
}

storySelector.addEventListener('change', () => {
  const key = fileSelector.value;
  const ds = datasets.get(key);
  const idx = parseInt(storySelector.value, 10);
  if (!ds || Number.isNaN(idx)) return;
  const story = ds.stories[idx];
  displayStory(story, `${ds.fileName} â€¢ ${story.title}`);
  updateStatus();
});

clearAllBtn.addEventListener('click', () => {
  datasets.clear();
  updateFileSelector();
  updateStatus();
  englishDisplay.textContent = '';
  currentChinese = '';
  currentEnglish = '';
  englishWordSpans = [];
  totalWords = 0;
  nowReading.textContent = 'Now reading: â€”';
  stopSpeaking();
  stopManualScroll();
  scrollSpeed.value = 0;
});

/* ========= Manual Scroll (when not following) ========= */
scrollSpeed.addEventListener('input', () => {
  if (followScroll.checked) return; // manual only when not following
  startManualScroll();
});
function startManualScroll(){
  stopManualScroll();
  const speed = parseInt(scrollSpeed.value, 10);
  if (speed > 0) {
    const delay = 1000 / (speed * 1.4);
    manualScrollInterval = setInterval(() => {
      englishDisplay.scrollTop += 1;
    }, delay);
  }
}
function stopManualScroll(){
  if (manualScrollInterval) {
    clearInterval(manualScrollInterval);
    manualScrollInterval = null;
  }
}

/* ========= Display & Highlight Prep ========= */
function displayStory(story, label){
  currentChinese = story.chinese || '';
  currentEnglish = story.english || '';
  nowReading.textContent = `Now reading: ${label || (story.title ?? 'â€”')}`;
  renderEnglishWithSpans(currentEnglish);
  englishDisplay.scrollTop = 0;
}

function renderEnglishWithSpans(text){
  // Split text into tokens while preserving whitespace & punctuation as separate tokens
  // We'll only "highlight" tokens classified as words; others pass through.
  const tokens = tokenizeEnglish(text);
  c
